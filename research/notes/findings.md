# BDF 输入格式研究发现

## 重要发现

### 发现 0：几何优化模块选择 ✅ 已确认
**日期**：2024年  
**重要性**：高

**内容**：
- 几何优化应使用 **RESP 模块**而非 GRAD 模块
- **GRAD 模块仅支持 Hartree-Fock 和 MCSCF**，不支持 DFT
- RESP 模块支持所有 SCF 方法（HF 和 DFT）以及 TDDFT

**影响**：
- 对于 DFT 计算，必须使用 RESP 模块
- 为了统一和兼容性，建议所有几何优化都使用 RESP 模块

**应用**：
- 优化任务类型映射：`optimize` → `COMPASS` + `BDFOPT` + `XUANYUAN` + `SCF` + `RESP`
- RESP 模块参数：`geom`、`norder 1`（梯度）、`method 1`（SCF 梯度）

---

### 发现 1：模块化结构
**日期**：2024年  
**重要性**：高

**内容**：
BDF 输入采用模块化设计，每个模块从 `$MODULE_NAME` 开始，到 `$END` 结束。模块按计算流程顺序执行。

**影响**：
- 我们的转换器需要按模块生成
- 不同计算类型需要不同的模块组合
- 模块顺序很重要

**应用**：
- 在生成器中按模块组织代码
- 建立任务类型到模块组合的映射

---

### 发现 2：关键词+值格式
**日期**：2024年  
**重要性**：高

**内容**：
BDF 使用"关键词+值"模式，关键词在单独一行，值在关键词的下一行（或多行）。

**影响**：
- 生成 BDF 输入时需要正确处理换行
- 多行值需要特殊处理

**应用**：
- 模板引擎需要支持这种格式
- 格式化器需要正确处理缩进和换行

---

### 发现 3：坐标格式
**日期**：2024年  
**重要性**：高

**内容**：
- 坐标格式：`原子符号 X Y Z`（自由格式，空格分隔）
- 坐标块在 `Geometry` 和 `End geometry` 之间
- 默认单位是 Bohr（可通过 `Unit` 指定）

**影响**：
- 需要将我们的 YAML 坐标（Angstrom）转换为 Bohr
- 需要处理坐标块的格式

**应用**：
- 坐标转换函数：Angstrom → Bohr（乘以 1.8897259886）
- 坐标格式化函数

---

### 发现 4：SCF 方法类型
**日期**：2024年  
**重要性**：高

**内容**：
- RHF/UHF：Hartree-Fock（不需要 `dft functional`）
- RKS/UKS：DFT（需要 `dft functional` 指定泛函）
- 选择规则：根据自旋多重度决定

**影响**：
- 需要根据 YAML 配置自动选择正确的方法类型
- 需要正确处理 DFT 泛函指定

**应用**：
- 方法选择逻辑：type + multiplicity → RHF/UHF/RKS/UKS
- DFT 泛函映射表

---

### 发现 5：基组名称
**日期**：2024年  
**重要性**：中

**内容**：
- 基组名称直接使用（如 `cc-pvdz`、`6-31G`）
- 大小写可能不敏感（`CC-PVDZ` 和 `cc-pvdz` 都出现）
- 直接写在 `Basis` 关键词下一行

**影响**：
- 基组映射相对简单
- 可能需要标准化大小写

**应用**：
- 基组名称映射表（主要是大小写标准化）

---

### 发现 6：Occupied 格式 ✅ 已确认
**日期**：2024年  
**重要性**：中

**内容**：
`Occupied` 关键词指定 RHF 或 RKS 计算时不可约表示的双占据轨道数目，采用 D2h 及其子群的对称性。格式为四个整数，如 `3 0 1 0`。

**关键规则**：
- **默认可以不输入**：如果用户不指定，BDF 会自动计算
- **用户输入优先**：如果用户在 YAML 中指定了值，直接使用用户输入
- **仅用于 RHF/RKS**：UHF/UKS 使用 `Alpha` 和 `Beta`

**影响**：
- 这是一个可选参数，简化了我们的实现
- 如果用户提供了值，直接使用即可
- 不需要我们计算占据轨道数

**应用**：
- 在 YAML 中添加可选字段 `settings.scf.occupied`
- 如果用户提供了值，直接输出到 BDF 输入
- 如果用户没有提供，不输出该关键词（让 BDF 自动处理）

---

### 发现 7：TDDFT 模块
**日期**：2024年  
**重要性**：中

**内容**：
TDDFT 模块有大量参数，包括 `imethod`、`isf`、`itda`、`Nexit` 等。参数值在关键词下一行。

**影响**：
- TDDFT 计算需要更多参数
- 需要建立参数映射和默认值

**应用**：
- TDDFT 参数映射表
- 默认值配置

---

## 遇到的问题

### 问题 1：Occupied 格式的具体含义 ✅ 已解决
**日期**：2024年  
**严重性**：中

**问题描述**：
`Occupied` 关键词的值格式 `3 0 1 0` 的具体含义不清楚。

**解决方案**：
已确认：
- 指定 RHF 或 RKS 计算时不可约表示的双占据轨道数目
- 采用 D2h 及其子群的对称性
- 四个整数分别对应不同不可约表示的双占据轨道数
- **默认可以不输入**，BDF 会自动计算
- **如果用户指定了值，直接使用用户输入**

**状态**：✅ 已解决

---

### 问题 2：大小写敏感性 ✅ 已确认
**日期**：2024年  
**严重性**：低

**问题描述**：
在示例中看到 `$SCF` 和 `$scf`、`$END` 和 `$end` 都出现，不确定是否真的不敏感。

**解决方案**：
已确认：
- **模块名大小写不敏感**：`$COMPASS`、`$compass`、`$Compass` 都可以
- **关键词大小写不敏感**：`Title`、`title`、`TITLE` 都可以
- **BDF 会自动处理**：BDF 会自动标准化大小写

**建议**：
- 为了可读性和一致性，建议使用标准格式
- 模块名：使用大写（如 `$COMPASS`、`$SCF`）
- 关键词：使用首字母大写（如 `Title`、`Basis`、`Geometry`）

**状态**：✅ 已确认

---

### 问题 3：默认值和可选参数
**日期**：2024年  
**严重性**：中

**问题描述**：
很多参数在示例中没有出现，不确定是否有默认值，或者哪些是必需的。

**可能原因**：
- BDF 可能有默认值
- 某些参数可能只在特定情况下需要

**解决方案**：
- 查阅 BDF 用户手册
- 测试最小输入
- 建立参数必需性列表

**状态**：待解决

---

## 待确认事项

- [x] Occupied 格式的具体含义和计算方法 ✅ 已确认
- [x] 大小写敏感性（模块名和关键词）✅ 已确认：不敏感，BDF 自动处理
- [ ] 各参数的默认值
- [ ] 频率计算的具体模块组合
- [ ] 更多 DFT 泛函的 BDF 名称
- [ ] 几何优化的收敛参数设置
- [ ] 对称性 Group 关键词的完整选项
- [ ] 其他模块的关键词（如 MCSCF、TRAINT、drt、MRCI）

---

## 研究进展

### 2024年 - 初始分析
- ✅ 分析了 8 个 BDF 输入文件示例
- ✅ 识别了主要模块：COMPASS, XUANYUAN, SCF, BDFOPT, TDDFT, RESP
- ✅ 理解了基本格式：模块化结构、关键词+值模式
- ✅ 建立了初步的映射关系
- ✅ 记录了重要发现和待解决问题

---

## 下一步计划

1. **完善映射表**
   - 补充更多 DFT 泛函映射
   - 补充更多基组映射
   - 完善参数映射

2. **解决待确认问题**
   - 查阅 BDF 用户手册
   - 测试验证大小写敏感性
   - 理解 Occupied 格式

3. **扩展分析**
   - 分析频率计算示例（如果有）
   - 分析更多高级功能示例
   - 理解所有模块的关键词

4. **建立转换规则**
   - 坐标单位转换（Angstrom → Bohr）
   - 方法类型选择规则
   - 参数格式转换规则
